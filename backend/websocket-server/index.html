<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Notificaciones - Sistema Turístico</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 8px;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.9em;
        }

        .status {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
            margin-top: 15px;
            gap: 8px;
        }

        .status.disconnected {
            background: #e74c3c;
        }

        .status.connected {
            background: #27ae60;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        .notifications-panel {
            padding: 30px;
        }

        .notifications-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .notifications-header h2 {
            color: #2c3e50;
            font-size: 1.4em;
        }

        .clear-btn {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .clear-btn:hover {
            background: #7f8c8d;
        }

        .notifications-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #ecf0f1;
            border-radius: 8px;
            background: #fafafa;
        }

        .notification {
            padding: 15px;
            border-bottom: 1px solid #ecf0f1;
            animation: slideIn 0.3s ease-out;
        }

        .notification:last-child {
            border-bottom: none;
        }

        .notification.tour-created {
            border-left: 4px solid #3498db;
            background: #ebf3fd;
        }

        .notification.booking-created {
            border-left: 4px solid #2ecc71;
            background: #e8f8f5;
        }

        .notification.user-registered {
            border-left: 4px solid #f39c12;
            background: #fef9e7;
        }

        .notification.service-contracted {
            border-left: 4px solid #9b59b6;
            background: #f4ecf7;
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .notification-title {
            font-weight: bold;
            color: #2c3e50;
            font-size: 0.9em;
        }

        .notification-time {
            font-size: 0.8em;
            color: #7f8c8d;
        }

        .notification-content {
            color: #34495e;
            font-size: 0.85em;
            line-height: 1.4;
        }

        .no-notifications {
            text-align: center;
            padding: 40px;
            color: #95a5a6;
            font-style: italic;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #ecf0f1;
        }

        .stat-number {
            font-size: 1.5em;
            font-weight: bold;
            color: #2c3e50;
        }

        .stat-label {
            font-size: 0.8em;
            color: #7f8c8d;
            text-transform: uppercase;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1> Panel de Notificaciones</h1>
            <p>Sistema de Monitoreo en Tiempo Real - APIs Turísticas</p>
            <div id="connectionStatus" class="status disconnected">
                <div class="status-indicator"></div>
                Desconectado
            </div>
        </div>

        <div class="notifications-panel">
            <div class="stats">
                <div class="stat-card">
                    <div id="tourCount" class="stat-number">0</div>
                    <div class="stat-label">Tours</div>
                </div>
                <div class="stat-card">
                    <div id="bookingCount" class="stat-number">0</div>
                    <div class="stat-label">Reservas</div>
                </div>
                <div class="stat-card">
                    <div id="userCount" class="stat-number">0</div>
                    <div class="stat-label">Usuarios</div>
                </div>
                <div class="stat-card">
                    <div id="contratacionCount" class="stat-number">0</div>
                    <div class="stat-label">Contrataciones</div>
                </div>
                <div class="stat-card">
                    <div id="recomendacionCount" class="stat-number">0</div>
                    <div class="stat-label">Recomendaciones</div>
                </div>
            </div>

            <div class="notifications-header">
                <h2>Notificaciones Recientes</h2>
                <button class="clear-btn" onclick="clearNotifications()">Limpiar Todo</button>
            </div>

            <div id="notificationsContainer" class="notifications-container">
                <div class="no-notifications">
                    No hay notificaciones aún. Esperando eventos de las APIs...
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io('http://localhost:4001');
        
        const connectionStatus = document.getElementById('connectionStatus');
        const notificationsContainer = document.getElementById('notificationsContainer');
        const tourCount = document.getElementById('tourCount');
        const bookingCount = document.getElementById('bookingCount');
        const userCount = document.getElementById('userCount');
        const contratacionCount = document.getElementById('contratacionCount');
        const recomendacionCount = document.getElementById('recomendacionCount');

        let stats = {
            tours: 0,
            bookings: 0,
            users: 0,
            contrataciones: 0,
            recomendaciones: 0
        };

        let notifications = [];

        // Cargar estadísticas iniciales desde las APIs
        async function loadInitialStats() {
            try {
                // Cargar tours
                const toursRes = await fetch('http://localhost:3000/api/tours');
                if (toursRes.ok) {
                    const toursData = await toursRes.json();
                    stats.tours = Array.isArray(toursData) ? toursData.length : (toursData.data ? toursData.data.length : 0);
                }

                // Cargar reservas
                const reservasRes = await fetch('http://localhost:3000/api/reservas');
                if (reservasRes.ok) {
                    const reservasData = await reservasRes.json();
                    stats.bookings = Array.isArray(reservasData) ? reservasData.length : (reservasData.data ? reservasData.data.length : 0);
                }

                // Cargar usuarios
                const usuariosRes = await fetch('http://localhost:8000/usuarios');
                if (usuariosRes.ok) {
                    const usuariosData = await usuariosRes.json();
                    stats.users = Array.isArray(usuariosData) ? usuariosData.length : 0;
                }

                // Cargar contrataciones
                const contratacionesRes = await fetch('http://localhost:8080/contrataciones');
                if (contratacionesRes.ok) {
                    const contratacionesData = await contratacionesRes.json();
                    stats.contrataciones = Array.isArray(contratacionesData) ? contratacionesData.length : (contratacionesData.data ? contratacionesData.data.length : 0);
                }

                // Cargar recomendaciones
                const recomendacionesRes = await fetch('http://localhost:8000/recomendaciones');
                if (recomendacionesRes.ok) {
                    const recomendacionesData = await recomendacionesRes.json();
                    stats.recomendaciones = Array.isArray(recomendacionesData) ? recomendacionesData.length : 0;
                }

                updateStats();
                console.log('✅ Estadísticas cargadas:', stats);
            } catch (error) {
                console.error('❌ Error cargando estadísticas:', error);
            }
        }

        socket.on('connect', function() {
            console.log('✅ Conectado al WebSocket');
            connectionStatus.className = 'status connected';
            connectionStatus.innerHTML = '<div class="status-indicator"></div>Conectado';
            
            // Unirse a la sala dashboard
            socket.emit('join_room', 'dashboard');
            
            // Cargar estadísticas iniciales
            loadInitialStats();
        });

        socket.on('disconnect', function() {
            console.log('❌ Desconectado del WebSocket');
            connectionStatus.className = 'status disconnected';
            connectionStatus.innerHTML = '<div class="status-indicator"></div>Desconectado';
        });

        // ========== EVENTOS DE RESERVAS ==========
        socket.on('nueva_reserva', function(data) {
            console.log('🎫 Nueva reserva:', data);
            addNotification('booking-created', 'Nueva Reserva', data.mensaje || 'Nueva reserva creada');
            stats.bookings++;
            updateStats();
        });

        socket.on('reserva_actualizada', function(data) {
            console.log('✏️ Reserva actualizada:', data);
            addNotification('booking-created', 'Reserva Actualizada', data.mensaje || 'Reserva actualizada');
        });

        // ========== EVENTOS DE CONTRATACIONES ==========
        socket.on('nueva_contratacion', function(data) {
            console.log('📝 Nueva contratación:', data);
            addNotification('service-contracted', 'Nueva Contratación', data.mensaje || 'Nueva contratación creada');
            stats.contrataciones++;
            updateStats();
        });

        socket.on('contratacion_actualizada', function(data) {
            console.log('✏️ Contratación actualizada:', data);
            addNotification('service-contracted', 'Contratación Actualizada', data.mensaje || 'Contratación actualizada');
        });

        // ========== EVENTOS DE RECOMENDACIONES ==========
        socket.on('nueva_recomendacion', function(data) {
            console.log('⭐ Nueva recomendación:', data);
            addNotification('tour-created', 'Nueva Recomendación', data.mensaje || 'Nueva recomendación creada');
            stats.recomendaciones++;
            updateStats();
        });

        socket.on('recomendacion_actualizada', function(data) {
            console.log('✏️ Recomendación actualizada:', data);
            addNotification('tour-created', 'Recomendación Actualizada', data.mensaje || 'Recomendación actualizada');
        });

        // ========== EVENTOS DE USUARIOS ==========
        socket.on('usuario_registrado', function(data) {
            console.log('👤 Nuevo usuario registrado:', data);
            addNotification('user-registered', 'Nuevo Usuario', data.mensaje || 'Usuario registrado: ' + data.nombre + ' ' + data.apellido);
            stats.users++;
            updateStats();
        });

        // ========== EVENTOS DE TOURS ==========
        socket.on('tour_actualizado', function(data) {
            console.log('🗺️ Tour actualizado:', data);
            addNotification('tour-created', 'Tour ' + (data.accion || 'actualizado'), data.mensaje || 'Tour ' + data.nombre + ' ' + (data.accion || 'actualizado'));
            if (data.accion === 'creado') {
                stats.tours++;
                updateStats();
            }
        });

        // ========== EVENTOS LEGACY (por compatibilidad) ==========
        socket.on('tour_creado', function(data) {
            addNotification('tour-created', 'Nuevo Tour Creado', 'Tour "' + data.nombre + '" creado exitosamente');
            stats.tours++;
            updateStats();
        });

        socket.on('reserva_creada', function(data) {
            addNotification('booking-created', 'Nueva Reserva', 'Reserva para "' + data.tour_nombre + '" por ' + data.usuario_nombre);
            stats.bookings++;
            updateStats();
        });

        socket.on('servicio_contratado', function(data) {
            addNotification('service-contracted', 'Servicio Contratado', 'Servicio "' + data.nombre + '" contratado');
            stats.services++;
            updateStats();
        });

        function addNotification(type, title, content) {
            var notification = {
                id: Date.now(),
                type: type,
                title: title,
                content: content,
                timestamp: new Date()
            };

            notifications.unshift(notification);

            if (notifications.length > 50) {
                notifications = notifications.slice(0, 50);
            }

            renderNotifications();
        }

        function renderNotifications() {
            if (notifications.length === 0) {
                notificationsContainer.innerHTML = 
                    '<div class="no-notifications">No hay notificaciones aún. Esperando eventos de las APIs...</div>';
                return;
            }

            var notificationsHtml = notifications.map(function(notification) {
                return '<div class="notification ' + notification.type + '">' +
                    '<div class="notification-header">' +
                        '<div class="notification-title">' + notification.title + '</div>' +
                        '<div class="notification-time">' + formatTime(notification.timestamp) + '</div>' +
                    '</div>' +
                    '<div class="notification-content">' + notification.content + '</div>' +
                '</div>';
            }).join('');

            notificationsContainer.innerHTML = notificationsHtml;
        }

        function formatTime(date) {
            return date.toLocaleTimeString('es-ES', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        function updateStats() {
            tourCount.textContent = stats.tours;
            bookingCount.textContent = stats.bookings;
            userCount.textContent = stats.users;
            contratacionCount.textContent = stats.contrataciones;
            recomendacionCount.textContent = stats.recomendaciones;
        }

        function clearNotifications() {
            notifications = [];
            renderNotifications();
        }
    </script>
</body>
</html>
